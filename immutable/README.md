# immutable.js

## æ¦‚è¿°

Facebook å·¥ç¨‹å¸ˆ lee byron èŠ±è´¹ 3 å¹´æ—¶é—´æ‰“é€ ï¼Œä¸ react åŒæœŸå‡ºç°ï¼Œä½†æ²¡æœ‰è¢«é»˜è®¤æ”¾åˆ° react å·¥å…·é›†é‡Œï¼ˆReact æä¾›äº†ç®€åŒ–çš„ helperï¼‰

å®ƒå†…éƒ¨å®ç°äº†ä¸€å¥—å®Œæ•´çš„ Persistent Data Structureï¼Œè¿˜æœ‰å¾ˆå¤šæ˜“ç”¨çš„æ•°æ®ç±»å‹ã€‚åƒ Collectionã€Listã€Mapã€Setã€Recordã€Seqã€...

**ä¸‰ç§é‡è¦çš„æ•°æ®ç»“æ„**ï¼š

- Map: é”®å€¼å¯¹é›†åˆï¼Œå¯¹åº”äº Objectï¼ŒES6 ä¹Ÿæœ‰ä¸“é—¨çš„ Map å¯¹è±¡
- List: æœ‰åºå¯é‡å¤çš„åˆ—è¡¨ï¼Œå¯¹åº”äº Array
- Set: æ— éœ€ä¸”ä¸å¯é‡å¤çš„åˆ—è¡¨

ğŸ“¢  Immutable Data å°±æ˜¯ä¸€æ—¦åˆ›å»ºï¼Œå°±ä¸èƒ½å†è¢«æ›´æ”¹çš„æ•°æ®ã€‚
ğŸ“¢  å¯¹ Immutable å¯¹è±¡çš„ä»»ä½•ä¿®æ”¹æˆ–æ·»åŠ åˆ é™¤æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Immutable å¯¹è±¡ã€‚



**Link æŒ‡å‘**

[å®˜ç½‘æŒ‡å—](https://immutable-js.com/)

[ä¸­æ–‡å‚è€ƒæ–‡æ¡£](https://github.com/guisturdy/immutable-js-docs-cn)



## ä¸¤ä¸ªé—®é¢˜

é€šè¿‡ `æ¦‚è¿°` éƒ¨åˆ†æˆ‘ä»¬äº†è§£åˆ°äº† `immutable.js` çš„ä¸€äº›å†…å®¹ï¼Œä½†æ˜¯ **ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ `immutable.js`** å‘¢ï¼Ÿ **ä½¿ç”¨å®ƒå°±ä¸€å®šæ˜¯å¥½çš„å—ï¼Ÿ**

æˆ‘ä»¬æ¥å›ç­”ä¸€ä¸‹è¿™ä¸¤ä¸ªé—®é¢˜

**Q1ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦  `immutable.js` ä¸å¯æ”¹å˜æ•°æ®å‘¢ï¼Ÿ **  

1. è¿™é€šå¸¸è·Ÿ Redux è¿™æ ·çš„åº”ç”¨æœ‰å…³ï¼ŒRedux æœ‰ä¸€ä¸ªåŸºæœ¬åŸåˆ™æ˜¯**Redux é‡Œé¢çš„æ•°æ®æ˜¯åªè¯»çš„**ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨Redux é‡Œé¢æ“ä½œæ•°æ®çš„æ—¶å€™é¦–å…ˆéœ€è¦å¯¹æ•°æ®è¿›è¡Œæ‹·è´æ“ä½œï¼ˆæˆ‘ä»¬çŸ¥é“æ‹·è´æ˜¯æœ‰ä¸€å®šçš„æ€§èƒ½æ¶ˆè€—çš„ï¼‰
2. æœ‰ä¸€ç§åœºæ™¯ï¼šä¸€ä¸ªæ•°æ®åœ¨å¤šæ–¹æ³•å¤„è¢«å…±äº«ä½¿ç”¨ï¼Œå¦‚æœæŸä¸€ä¸ªåœ°æ–¹å°†æ•°æ®æ›´æ”¹äº†ï¼Œå¦ä¸€ä¸ªä½¿ç”¨çš„åœ°æ–¹å°±å®¹æ˜“å‡ºé—®é¢˜ï¼Œå¦‚æœå‡ºç°äº†é—®é¢˜ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹æˆ‘ä»¬æ˜¯å¾ˆéš¾å»å‘ç°é—®é¢˜ç‚¹åœ¨å“ªé‡Œçš„ï¼Œä»è€Œå¯¼è‡´é¡¹ç›®ä¸ç¨³å®š

å› ä¸ºä¸Šè¿°ä¸¤ç‚¹åŸå› ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾€å¾€éœ€è¦æ•°æ®åœ¨ä¼ é€’çš„è¿‡ç¨‹ä¸­æ˜¯ `åªè¯»çš„`ï¼ˆæ•°æ®ä¿®æ”¹å¾€å¾€æ˜¯BUGçš„æºå¤´ï¼‰

**Q2ï¼š `immutable.js`  çš„ä¼˜ç¼ºç‚¹æœ‰å“ªäº›ï¼Ÿ**

1. **ä¼˜ç‚¹**
   - é™ä½ `Mutable` å¸¦æ¥çš„å¤æ‚åº¦
   - èŠ‚çœå†…å­˜ç©ºé—´
     å¦‚æœä¸ä½¿ç”¨ `immutable` è¿›è¡Œæ·±æ‹·è´ï¼Œæˆ‘ä»¬ä¼šå°†æ•´ä¸ªå¯¹è±¡è¿›è¡Œæ·±æ‹·è´ï¼Œå¯èƒ½åªæ˜¯ä¸ºäº†å¯¹è±¡ä¸­çš„æŸä¸€ä¸ªå±æ€§ï¼ˆè¿™å¯¹å†…å­˜ç©ºé—´æ¥è®²æ¶ˆè€—æ˜¯å¾ˆå¤§çš„ï¼‰
     ä½¿ç”¨ `immutable` è¿›è¡Œæ·±æ‹·è´ä¿®æ”¹å¯¹è±¡ä¸­çš„æŸä¸€ä¸ªå±æ€§ï¼Œä»–åªä¼šä¿®æ”¹éœ€è¦æ”¹å˜çš„é‚£ä¸€ä¸ªå±æ€§ï¼Œå…¶ä»–çš„ä¸å˜ï¼ˆå¦‚æœè¿™ä¸ªå¯¹è±¡æ¯”è¾ƒå¤§ï¼Œè¿™æ ·çš„æ“ä½œå°†èŠ‚çº¦å¾ˆå¤§çš„å†…å­˜ç©ºé—´ï¼‰
   - æ–¹ä¾¿å¼€å‘ Undo / Redoï¼ŒCopy / Paste
     Copy / Pasteï¼š æ¯ä¸€æ¬¡æ“ä½œéƒ½æ˜¯å¯¹å¯¹è±¡çš„ä¸€æ¬¡æ‹·è´
     Undo / Redoï¼šæ¯ä¸€æ¬¡æ“ä½œéƒ½æ˜¯å¯¹æ•°æ®çš„æ”¹å˜ï¼Œæ¯ä¸€æ¬¡æ”¹å˜éƒ½ä¼šè¢«æ”¾ç½®åœ¨ä¸€ä¸ªæ•°ç»„é‡Œé¢ï¼Œå½“éœ€è¦æ’¤é”€æ“ä½œçš„æ—¶å€™å°±å°†æ•°ç»„é‡Œçš„æ•°æ®pull å‡ºæ¥å³å¯ï¼ˆundo/redo å°±æ˜¯æ•°æ®åœ¨æ•°ç»„ä¸­çš„ pull/push æ“ä½œï¼‰
   - æ‹¥æŠ±å‡½æ•°å¼ç¼–ç¨‹

2. **ç¼ºç‚¹**
   - å®¹æ˜“ä¸åŸç”Ÿå¯¹è±¡æ··æ·†



## å¸¸ç”¨ API

> é€šè¿‡ä»¥ä¸Šå†…å®¹çš„è®¤è¯†ï¼Œæˆ‘ä»¬å‘ç° `immutable.js` å¾ˆå€¼å¾—ä½¿ç”¨
>
> ğŸ“¢ è¯´æ˜ä¸€ä¸‹ï¼šè¿™ä¸€éƒ¨åˆ†åœ¨æ¢³ç†çš„æ—¶å€™å‘ç°[å®˜æ–¹æ–‡æ¡£]((https://immutable-js.com/))å·²ç»æ˜¯æœ€å¥½çš„æ–‡æ¡£äº†ï¼Œä¸­æ–‡è¯¦ç»†ä¸€ç‚¹çš„å¯ä»¥å‚è€ƒ[ä¸­æ–‡å‚è€ƒæ–‡æ¡£](https://github.com/guisturdy/immutable-js-docs-cn)ï¼ŒCrystal è¿™é‡Œå¤§è‡´ä¸Šåˆ—ä¸¾ä¸€äº›API å‡ºæ¥ç”¨ä½œå…¥é—¨

### List

> List å¯¹åº”åŸç”ŸJS çš„æ•°ç»„ç»“æ„ï¼Œåˆ›å»ºList çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼š**List æ˜¯å·¥å‚æ–¹æ³•ï¼Œä¸èƒ½ä½¿ç”¨ new åˆå§‹åŒ–**
>
> `const list = List([1, 2, 3, 4])`

#### é™æ€æ–¹æ³•

##### List.isList()

åˆ¤æ–­æ˜¯å¦æ˜¯ List ç±»å‹

`console.log(List.isList(list), List.isList([1, 2, 3]))`

##### List.of()

åˆ›å»ºæ–°çš„Listï¼ˆè·Ÿå·¥å‚æ–¹æ³•ç±»å‹ä¸åŒçš„æ˜¯å·¥å‚æ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯æ•°ç»„ï¼ŒList.of çš„å‚æ•°ä¸éœ€è¦åŠ ä¸­æ‹¬å·ï¼‰

`const listarr = List.of(1, 2, 3)`

#### å±æ€§

##### size

å–list çš„é•¿åº¦

`console.log('size', listarr.size)`

#### APIS

##### set

> set æ–¹æ³•ç”¨æ¥è®¾å®šæŒ‡å®šä¸‹æ ‡çš„å€¼ `set(ä¸‹æ ‡, å€¼)`

- set è®¾ç½®çš„ä¸‹æ ‡æ˜¯å¯ä»¥è¶…è¿‡æœ€å¤§é•¿åº¦çš„ï¼Œä¼šå°†ä¸­é—´æ²¡æœ‰å€¼çš„å‘ä½å¡«ä¸º undefined
- ä¸‹æ ‡å¯ä»¥æ˜¯è´Ÿå€¼ ä»å³å¾€å·¦æŸ¥

```js
const list_1 = listarr.set(0, 100)
const list_2 = listarr.set(10, 100)
const list_3 = listarr.set(-1, 100)
```

##### delete

> åˆ é™¤æŒ‡å®šä¸‹æ ‡çš„å€¼ `delete(ä¸‹æ ‡)`

- ä¸‹æ ‡å¯ä»¥æ˜¯è´Ÿå€¼ ä»å³å¾€å·¦æŸ¥

```js
const deletarr = List([1, 2, 3, 4])
const deletarr_1 = deletarr.delete(0)
const deletarr_2 = deletarr.delete(-2)
```

##### insert

> æ’å…¥å€¼ `insert(ä¸‹æ ‡,å€¼)`

- ä¸‹æ ‡å¯ä»¥æ˜¯è´Ÿå€¼ ä»å³å¾€å·¦æŸ¥
- è¯¥æ“ä½œä¼šå¯¹æ•°ç»„è¿›è¡Œå®Œæ•´çš„æ‹·è´

```js
const insert = List([1, 2, 3])
const insert_1 = insert.insert(1, 666)
```

##### update

> æ›´æ–°æŒ‡å®šä¸‹æ ‡çš„å€¼ update(ä¸‹æ ‡ï¼Œcallback)

```js
const u = List([1, 2, 3, 4]);
const u1 = u.update(1, x => x + 100);
```

##### clear

> æ¸…ç©ºå¹¶è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ–°æ•°ç»„

```js
const c = List([1, 2, 3, 4]);
const c1 = c.clear();
```

**push pop unshift shift åŒæ•°ç»„çš„åŒåæ–¹æ³•**

##### setSize

é‡æ–°è®¾å®šæ•°ç»„é•¿åº¦ï¼Œå°äºåŸæ•°ç»„é•¿åº¦ä¼šæˆªæ–­ï¼Œå¤§äºåŸæ•°ç»„é•¿åº¦ä¼šç”¨ undefined è¿›è¡Œå¡«å……

```js
const s = List([1, 2, 3, 4]);
const s1 = s.setSize(2);
const s2 = s.setSize(10);
```

##### setIn()

> ç”¨æ¥è®¾å®šåµŒå¥—ç»“æ„çš„å€¼ ` ([ç¬¬ä¸€å±‚ä¸‹æ ‡,ç¬¬äºŒå±‚ä¸‹æ ‡,...ç¬¬Nå±‚ä¸‹æ ‡], å€¼)`
>
> åŒç†è¿˜æœ‰ deleteIn, insertIn, updateIn

```js
const si = List([
    List([1, 2, 3, 4]),
    List([11, 22, 33, 44]),
    List([111, 222, 333, 444]),
])
const si1 = si.setIn([2, 1], 0)
```

##### concat

> è¿æ¥ List `concat(List1, List2, ...ListN)`

```js
const con1 = List([1, 2, 3, 4])
const con2 = List([2, 4, 6, 4])
const con3 = List([11, 22, 33])
const con = con1.concat(con2, con3)
```

##### merge

> concat çš„åˆ«å

```js
const con1 = List([1, 2, 3, 4])const con2 = List([2, 4, 6, 4])const con3 = List([11, 22, 33])const mer = con1.merge(con2, con3)console.log(mer)
```

##### map

> åŒåŸç”Ÿmapï¼Œå¾ªç¯è¿‡æ»¤å¹¶è¿”å›æ–°çš„List

##### filter

> åŒåŸç”Ÿfilterï¼Œå¾ªç¯è¿‡æ»¤å¹¶è¿”å›æ–°çš„List

##### flatten

> æ‰å¹³åŒ– list
>
> å‚æ•°ï¼š depth?: number || shallow?: boolean

##### find

> æŸ¥æ‰¾ï¼Œè¿”å›ç¬¬ä¸€ä¸ªç¬¦åˆçš„ç»“æœ

```js
const f1 = List(['a', 'b', 'c'])const f2 = f1.find((v, k) => v.includes('a'))
```

##### findLast

> æŸ¥æ‰¾ï¼Œè¿”å›æœ€åä¸€ä¸ªç¬¦åˆçš„ç»“æœ

```js
const f3 = f1.findLast((v, k) => v.includes('a'))
```

##### keys

> è¿”å›æ‰€æœ‰çš„ä¸‹æ ‡

```js
for (const k of f1.keys()) {    console.log('k', k)}
```

##### values

> è¿”å›æ‰€æœ‰çš„å€¼

```js
for (const v of f1.values()) {    console.log('v', v)}
```

##### entries

> è¿”å›æ‰€æœ‰ entry

```js
for (const entry of f1.entries()) {    console.log('entry', entry)}
```

##### groupBy

> åˆ†ç»„

å½“æ•°ç»„ä¸­çš„å…ƒç´ æ˜¯å¯¹è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹è±¡ä¸­çš„å±æ€§è¿›è¡Œåˆ†ç»„

```js
const group = List([    { id: 1, type: 'a'},    { id: 2, type: 'a'},    { id: 3, type: 'b'},    { id: 4, type: 'b'},])const g = group.groupBy(x => x.type)
```



### Map

> Map å¯¹åº”åŸç”ŸJSçš„object ç»“æ„ï¼Œä»–æ˜¯æ— åºçš„
>
> Map æ˜¯ **å·¥å‚æ–¹æ³•**ï¼Œ ä¸è¦ä½¿ç”¨ new å®ä¾‹åŒ–

`const map = Map({ x: 1, y: 2 })`


#### set

> è®¾å®šå€¼ set(key, value) `set(key, value)`

- keyã€value å¯ä»¥æ˜¯ä»»æ„ç±»å‹

```js
const m = Map({ x: 1, y: 2 })const m1 = m.set('z', 3)const m2 = m.set(List([1]), { user: 'w' })
```

#### get

> å–å€¼

`console.log(m1.get('z'))`

#### delete

> åˆ é™¤å€¼

```js
const d = Map({ x: 1, y: 2 })const d1 = d.delete('x')
```

#### deleteAll

> æ‰¹é‡åˆ é™¤ `deleteAll([key1, key2, ..., keyN])`

```js
const da = Map({ x: 1, y: 2, z: 3, u: 2 })const da1 = da.deleteAll(['x', 'z'])
```

#### clear

> æ¸…é™¤æ‰€æœ‰è¿”å›æ–°Map

`const cl = da.clear();`

#### update

> æ›´æ–° `update(key, callback)`

#### merge

> åˆæˆ N ä¸ª Map ä¸ºä¸€ä¸ª Map `merge(map1, map2, ...mapN)`

- ç±»ä¼¼äºåŸç”Ÿçš„ Object.assgin() çš„åŠŸèƒ½

#### concat

> merge çš„åˆ«å

#### mergeWith

> ç±»ä¼¼äº merge, ä½†æ˜¯æŒ‡å®šäº† merge çš„å…·ä½“è§„åˆ™(å¦‚æœé‡åˆ°é‡å¤çš„å€¼ï¼Œåˆå¹¶çš„è§„åˆ™)

```js
const m_1 = Map({ x: 1, y: 2 })const m_2 = Map({ y: 33, z: 3 })const m_3 = m_1.mergeWith((oldVal, newVal) => (newVal + '!!!'), m_2)
```



### OrderedMap

> æœ‰åºçš„Map, è¿­ä»£è¾“å‡ºçš„é¡ºåºæ˜¯è°ƒç”¨setçš„é¡ºåºã€‚ä¸ºäº†ç»´æŠ¤é¡ºåºï¼Œæ‰€ä»¥éœ€è¦æ›´é«˜çš„å¼€é”€

å¦‚æœæ²¡æœ‰é¡ºåºçš„éœ€æ±‚ï¼Œæ¨èä½¿ç”¨ Map

```js
const map = OrderedMap({})const map2 = map.set('z', 1);const map3 = map2.set('x', 2);
```



### Set

> Set å¯ä»¥ç†è§£ä¸º value å”¯ä¸€çš„æ•°ç»„ï¼Œå³æ•°ç»„ä¸­ä¸å…è®¸å‡ºç°é‡å¤çš„å€¼
>
> Set æ˜¯å·¥å‚æ–¹æ³•ï¼Œä¸å…è®¸ new æ¥å®ä¾‹åŒ–ï¼Œä¼šè‡ªåŠ¨å»é‡



### OrderSet

> OrderSet æ˜¯æœ‰åºçš„ Set, ä»–çš„é¡ºåºæ˜¯è°ƒç”¨ add æ·»åŠ å…ƒç´ çš„é¡ºåºï¼Œæ‹¥æœ‰Set çš„æ‰€æœ‰æ–¹æ³•å’Œå±æ€§

#### sort

> æ’åºæ–¹æ³• sort((valueA: T, valueB: T) => number)

å‡åºï¼š valueA - valueB

é™åºï¼š valueB - valueA



### Seq

> Seq æè¿°äº†ä¸€ä¸ª â€œæ‡’â€ æ“ä½œï¼Œå…è®¸ä½¿ç”¨ collection çš„å‘Šè¯«æ–¹æ³•çš„é«˜æ•ˆåœ°é“¾å¼è°ƒç”¨ï¼Œä½†æ˜¯ä¸ä¼šç”Ÿæˆä¸­é—´çš„ collectionsï¼ˆMap,List,Set, ...ï¼‰

- Seq  is immutable Seq æ˜¯ä¸å¯æ”¹å˜çš„
- Seq is lazy  Seq æ˜¯æ‡’çš„



### immutable å¯¹è±¡å’ŒåŸç”Ÿå¯¹è±¡çš„ç›¸äº’è½¬æ¢

#### åŸç”Ÿå¯¹è±¡è½¬ immutable å¯¹è±¡

`fromJS()` èƒ½å¤ŸæŠŠåŸç”Ÿçš„æ•°ç»„æˆ–è€…å¯¹è±¡è½¬æ¢æˆå¯¹åº”çš„ List æˆ–è€… Map

```js
const map = immutable.fromJS({ x: 1, y: 2})
```

#### immutable å¯¹è±¡è½¬åŸç”Ÿå¯¹è±¡

`toJS()` è½¬æ¢ä¸ºåŸç”Ÿå¯¹è±¡

- List -> æ•°ç»„
- Set -> æ•°ç»„
- Map -> å¯¹è±¡

```js
const list = List([1, 2, 3, 4]).toJS()
```



### Range

> `Range()` æ ¹æ®ç»™å®šçš„èŒƒå›´ç”Ÿæˆè¿‡ä¸€ä¸ªSeq



### Repeat

é‡å¤ç”Ÿæˆ N ä¸ªå€¼å¾—Seq, å½“æ²¡æœ‰ä¼ å…¥ times çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆé•¿åº¦ä¸º infinite çš„ Seq



# ä¸ react + redux ç»“åˆä½¿ç”¨

åœ¨ redux ä¸­éœ€è¦ä½¿ç”¨ `immutable.js` çš„æƒ…å†µï¼Œéœ€è¦ä½¿ç”¨åˆ° `redux-immutable` åº“



